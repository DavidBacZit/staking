<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staking dApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal/dist/index.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 8px 16px; }
    input { padding: 8px; margin: 5px; }
    #statusMessage { color: #555; margin-top: 10px; }
  </style>
</head>
<body>
  <button id="connectBtn">Connect Wallet</button>
  <div id="accountDisplay"></div>

  <div>
    <input id="stakeAmount" type="number" placeholder="Amount to stake" step="0.1" />
    <button id="approveBtn" disabled>Approve</button>
    <button id="stakeBtn" disabled>Stake</button>
  </div>

  <div>
    <p>Current rate: <span id="rateDisplay">–</span> stTokens per 1 Token</p>
    <p>Your stToken balance: <span id="balanceDisplay">–</span></p>
  </div>

  <div id="statusMessage"></div>

  <script>
    const TOKEN_ADDRESS = '0xToken';
    const STAKING_ADDRESS = '0xStakingContractAddress';
    const CHAIN_ID = 10143;
    const RPC_URL = 'https://testnet-rpc.monad.xyz';

    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function approve(address, uint256) returns (bool)',
      'function totalSupply() view returns (uint256)'
    ];

    const STAKING_ABI = [
      'function stake(uint256 amount) external',
      'function totalSupply() view returns (uint256)',
      'function balanceOf(address) view returns (uint256)'
    ];

    let provider;
    let signer;
    let tokenContract;
    let stakingContract;

    async function connectWallet() {
      try {
        if (window.ethereum) {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
        } else {
          const web3Modal = new Web3Modal({
            cacheProvider: false,
            providerOptions: {
              walletconnect: {
                package: WalletConnectProvider,
                options: {
                  rpc: { [CHAIN_ID]: RPC_URL },
                  chainId: CHAIN_ID
                }
              }
            }
          });
          const instance = await web3Modal.connect();
          provider = new ethers.providers.Web3Provider(instance);
          signer = provider.getSigner();
        }

        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID) {
          try {
            await provider.send("wallet_switchEthereumChain", [{ chainId: `0x${CHAIN_ID.toString(16)}` }]);
          } catch (switchError) {
            if (switchError.code === 4902) {
              await provider.send("wallet_addEthereumChain", [{
                chainId: `0x${CHAIN_ID.toString(16)}`,
                chainName: "Monad Testnet",
                rpcUrls: [RPC_URL],
                nativeCurrency: { name: "MON", symbol: "MON" },
                blockExplorerUrls: []
              }]);
              await provider.send("wallet_switchEthereumChain", [{ chainId: `0x${CHAIN_ID.toString(16)}` }]);
            } else {
              throw switchError;
            }
          }
        }

        tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
        stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

        const account = await signer.getAddress();
        document.getElementById('accountDisplay').textContent = `Connected: ${account}`;
        document.getElementById('approveBtn').disabled = false;
        document.getElementById('stakeBtn').disabled = false;

        await updateData();
      } catch (error) {
        console.error('Connection error:', error);
        document.getElementById('statusMessage').textContent = `Connection error: ${error.message}`;
      }
    }

    async function approve() {
      try {
        const amount = document.getElementById('stakeAmount').value;
        if (!amount || parseFloat(amount) <= 0) {
          document.getElementById('statusMessage').textContent = "Please enter a valid amount";
          return;
        }
        const amountBN = ethers.utils.parseUnits(amount, 18);
        document.getElementById('statusMessage').textContent = "Approving...";
        const tx = await tokenContract.approve(STAKING_ADDRESS, amountBN);
        await tx.wait();
        document.getElementById('statusMessage').textContent = "Approval successful";
        setTimeout(() => document.getElementById('statusMessage').textContent = "", 3000);
      } catch (error) {
        console.error('Approval error:', error);
        document.getElementById('statusMessage').textContent = `Approval error: ${error.message}`;
      }
    }

    async function stake() {
      try {
        const amount = document.getElementById('stakeAmount').value;
        if (!amount || parseFloat(amount) <= 0) {
          document.getElementById('statusMessage').textContent = "Please enter a valid amount";
          return;
        }
        const amountBN = ethers.utils.parseUnits(amount, 18);
        document.getElementById('statusMessage').textContent = "Staking...";
        const tx = await stakingContract.stake(amountBN);
        await tx.wait();
        document.getElementById('statusMessage').textContent = "Stake successful";
        setTimeout(() => document.getElementById('statusMessage').textContent = "", 3000);
        await updateData();
      } catch (error) {
        console.error('Staking error:', error);
        document.getElementById('statusMessage').textContent = `Staking error: ${error.message}`;
      }
    }

    async function updateData() {
      try {
        if (!signer) return;
        const totalStTokenSupply = await stakingContract.totalSupply();
        const totalUnderlyingTokens = await tokenContract.balanceOf(STAKING_ADDRESS);
        const rate = totalUnderlyingTokens.gt(0)
          ? totalStTokenSupply.mul(ethers.utils.parseUnits("1", 18)).div(totalUnderlyingTokens)
          : ethers.utils.parseUnits("1", 18);
        const userAddress = await signer.getAddress();
        const userBalance = await stakingContract.balanceOf(userAddress);

        document.getElementById('rateDisplay').textContent = ethers.utils.formatUnits(rate, 18);
        document.getElementById('balanceDisplay').textContent = ethers.utils.formatUnits(userBalance, 18);
      } catch (error) {
        console.error('Update data error:', error);
      }
    }

    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('approveBtn').addEventListener('click', approve);
    document.getElementById('stakeBtn').addEventListener('click', stake);
  </script>
</body>
</html>
